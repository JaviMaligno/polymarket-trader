name: Deploy to GCP

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/992492426638/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-deploy@project-94e9f6f2-aba7-4cb6-afc.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to VM
        run: |
          gcloud compute ssh polymarket-vm \
            --zone=us-east1-b \
            --command="cd ~/polymarket-trader && git pull origin main && docker compose -f docker-compose.gcp.yml up -d --build"

      - name: Health check
        run: |
          sleep 30
          curl -f http://34.74.36.101:3001/health || echo "API health check failed"
          curl -f http://34.74.36.101:10000/health || echo "Data collector health check failed"
